#!/bin/bash

# ==============================================================
# üìå Function: git_check
# --------------------------------------------------------------
# This script checks whether Git is installed and verifies
# if its version matches the required version.
#
# ‚úÖ USAGE:
#   1Ô∏è‚É£ From another script:
#       source ./.devenv/tools/git/check
#       git_check "2.47.1"
#
#   2Ô∏è‚É£ Directly from CLI:
#       bash ./.devenv/tools/git/check ">=2.47.1"
#
# ‚úÖ PARAMETERS:
#   - GIT_REQUIRED_VERSION (optional): Expected Git version (default: "latest").
#
# ‚úÖ RETURNS:
#   - GIT_IS_INSTALLED (bool)        : `true` if Git is installed, `false` otherwise.
#   - GIT_VERSION_MATCH (bool)    : `true` if installed version matches required.
#   - GIT_INSTALLED_VERSION (str) : Installed Git version (e.g., "2.47.1").
#
# ‚úÖ EXPORTS:
#   These values are exported for use in other scripts.
#
# ‚úÖ EXAMPLES:
#   # Test from CLI
#   bash ./.devenv/tools/git/check ">=2.47.1"
#
#   # Source from another script
#   source ./.devenv/tools/git/check
#   git_check "2.47.1"
#   echo "Git Installed: $GIT_IS_INSTALLED, Version: $GIT_INSTALLED_VERSION"
#
# --------------------------------------------------------------
# üîí License:
# Copyright 2025 ¬© Astitv Singh <https://github.com/astitvsingh>
# SPDX-License-Identifier: MIT
# ==============================================================

# --------------------------------------------------------------
# ‚ö†Ô∏è Ensure the script exits immediately if any command fails.
# --------------------------------------------------------------
set -e

# --------------------------------------------------------------
# üõ†Ô∏è Function: git_check
# --------------------------------------------------------------
# üîπ Checks whether Git is installed.
# üîπ Determines if its version matches the required version.
# üîπ Exports relevant status variables.
# --------------------------------------------------------------
# üõ†Ô∏è Parameters:
#   - $1 (optional) ‚Üí GIT_REQUIRED_VERSION (default: "latest")
# --------------------------------------------------------------
git_check() {
  # Read the required Git version from arguments; default is "latest".
  local GIT_REQUIRED_VERSION=${1:-"latest"}

  # Define default values for Git status variables.
  GIT_IS_INSTALLED=false        # Is Git installed?
  GIT_VERSION_MATCH=false    # Does Git version match the required version?
  GIT_INSTALLED_VERSION="none"  # Stores the installed Git version.

  echo "üîç  Checking Git installation..."

  # --------------------------------------------------------------
  # üöÄ Step 1: Check if Git is installed using `command -v`
  # --------------------------------------------------------------
  # ‚úÖ `command -v git`: Checks if `git` exists in system PATH.
  # ‚úÖ `&>/dev/null`: Suppresses output (used for silent checks).
  # --------------------------------------------------------------
  if command -v git &>/dev/null; then
    GIT_IS_INSTALLED=true  # Git is installed.
    
    # Fetch the installed Git version.
    # `git --version` prints something like: "git version 2.34.1"
    # `awk '{print $3}'` extracts the third word (the version number).
    GIT_INSTALLED_VERSION=$(git --version | awk '{print $3}')
    
    echo "‚úÖ  Git is installed: version $GIT_INSTALLED_VERSION"

    # üîç Step 1: Extract only the numeric part of the installed version (e.g., "2.47.1" from "2.47.1.windows.2")
    GIT_INSTALLED_VERSION_CLEAN=$(echo "$GIT_INSTALLED_VERSION" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')

    # üîç Step 2: Extract only the numeric part of the required version (e.g., "2.47.1" from ">=2.47.1")
    GIT_REQUIRED_VERSION_CLEAN=$(echo "$GIT_REQUIRED_VERSION" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')

    # --------------------------------------------------------------
    # üöÄ Step 2: Compare Installed Version with Required Version
    # --------------------------------------------------------------
    # - If GIT_REQUIRED_VERSION is "latest", assume it's always valid.
    # - If installed version matches the required version, mark as matched.
    
    # ‚úÖ If version requirement is "latest", assume it's always valid
    if [[ "$GIT_REQUIRED_VERSION" == "latest" ]]; then
      GIT_VERSION_MATCH=true
    else
      # ‚úÖ Compare Versions Using sort -V
      if [[ "$(printf "%s\n%s" "$GIT_REQUIRED_VERSION_CLEAN" "$GIT_INSTALLED_VERSION_CLEAN" | sort -V | head -1)" == "$GIT_REQUIRED_VERSION_CLEAN" ]]; then
        GIT_VERSION_MATCH=true
        echo "‚úÖ  Git version meets or exceeds required version ($GIT_REQUIRED_VERSION_CLEAN)."
      else
        echo "‚ö†Ô∏è  Git version mismatch (Installed: $GIT_INSTALLED_VERSION_CLEAN, Required: $GIT_REQUIRED_VERSION_CLEAN)."
      fi
    fi
  else
    echo "‚ùå  Git is not installed."
  fi

  # --------------------------------------------------------------
  # üöÄ Step 3: Export Variables for External Use
  # --------------------------------------------------------------
  # These exported variables can be used by other scripts.
  export GIT_REQUIRED_VERSION
  export GIT_IS_INSTALLED
  export GIT_VERSION_MATCH
  export GIT_INSTALLED_VERSION
}

# --------------------------------------------------------------
# üõ†Ô∏è Direct Execution Handling (Allows CLI Usage)
# --------------------------------------------------------------
# ‚úÖ If executed directly (not sourced), run `git_check` function.
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  git_check "$1"
  echo "üîç  .devenv/tools/git/check Output:"
  echo "    - GIT_REQUIRED_VERSION: $GIT_REQUIRED_VERSION"
  echo "    - GIT_IS_INSTALLED: $GIT_IS_INSTALLED"
  echo "    - GIT_VERSION_MATCH: $GIT_VERSION_MATCH"
  echo "    - GIT_INSTALLED_VERSION: $GIT_INSTALLED_VERSION"
fi
